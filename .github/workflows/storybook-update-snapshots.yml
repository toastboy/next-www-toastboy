name: Update Storybook Snapshots

on: workflow_dispatch

jobs:
    update-snapshots:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - uses: actions/checkout@v6

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Build Storybook
              run: npm run build:storybook

            - name: Start Storybook
              run: |
                  npm run storybook -- --ci --disable-telemetry --host 0.0.0.0 --port 6006 > /tmp/storybook.log 2>&1 &
                  npx wait-on http://127.0.0.1:6006

            - name: Update Snapshots
              run: npm run test:storybook:update-snapshots

            - name: Upload Storybook logs
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: storybook-snapshot-logs
                  path: /tmp/storybook.log
                  if-no-files-found: ignore
                  retention-days: 14

            - name: Commit and push snapshots
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add e2e/storybook.spec.ts-snapshots/
                  git commit -m "chore: update storybook visual regression snapshots" || echo "No changes to commit"
                  git push

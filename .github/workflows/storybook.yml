name: Storybook Tests

on: [push]

jobs:
    test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            checks: write

        steps:
            - uses: actions/checkout@v6

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: npm

            # So Chromatic doesn't get confused
            - name: Configure git identity
              run: |
                  git config --global user.email "ci@github.com"
                  git config --global user.name "GitHub Actions"

            - name: Install dependencies
              run: npm ci

            - name: Generate prisma client and zod schemas
              run: npm run generate

            - name: Build Storybook
              run: npm run build:storybook

            - name: Start Storybook
              run: |
                  npm run storybook -- --ci --disable-telemetry --host 0.0.0.0 --port 6006 > /tmp/storybook.log 2>&1 &
                  npx wait-on http://127.0.0.1:6006

            - name: Run Storybook tests
              run: npm run test:storybook

            - name: Upload Storybook logs
              if: always()
              uses: actions/upload-artifact@v7
              with:
                  name: storybook-test-logs
                  path: /tmp/storybook.log
                  if-no-files-found: ignore
                  retention-days: 14

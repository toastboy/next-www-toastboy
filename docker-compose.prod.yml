services:
  db:
    image: mariadb:lts
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mariadb-admin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  seeder:
    build:
      context: .
      target: seeder
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: "mysql://root:${MYSQL_ROOT_PASSWORD}@db:3306/footy"
      AZURE_TENANT_ID: ${AZURE_TENANT_ID}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET}
      AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_CONTAINER_NAME: ${AZURE_CONTAINER_NAME}
    profiles:
      - seed

  nodeapp:
    image: next-www-toastboy:latest
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: "mysql://root:${MYSQL_ROOT_PASSWORD}@db:3306/footy"
      SECRETS_DIR: /run/secrets
    secrets:
      - AZURE_CLIENT_ID
      - AZURE_TENANT_ID
      - AZURE_CLIENT_SECRET
      - AZURE_STORAGE_ACCOUNT_NAME
      - AZURE_CONTAINER_NAME
      - BETTER_AUTH_SECRET
      - BETTER_AUTH_URL
      - GOOGLE_CLIENT_ID
      - GOOGLE_CLIENT_SECRET
      - MICROSOFT_CLIENT_ID
      - MICROSOFT_CLIENT_SECRET
      - SENTRY_AUTH_TOKEN
      - MAIL_FROM_ADDRESS
      - MAIL_FROM_NAME
      - SMTP_HOST

secrets:
  AZURE_CLIENT_ID:
    environment: AZURE_CLIENT_ID
  AZURE_TENANT_ID:
    environment: AZURE_TENANT_ID
  AZURE_CLIENT_SECRET:
    environment: AZURE_CLIENT_SECRET
  AZURE_STORAGE_ACCOUNT_NAME:
    environment: AZURE_STORAGE_ACCOUNT_NAME
  AZURE_CONTAINER_NAME:
    environment: AZURE_CONTAINER_NAME
  BETTER_AUTH_SECRET:
    environment: BETTER_AUTH_SECRET
  BETTER_AUTH_URL:
    environment: BETTER_AUTH_URL
  GOOGLE_CLIENT_ID:
    environment: GOOGLE_CLIENT_ID
  GOOGLE_CLIENT_SECRET:
    environment: GOOGLE_CLIENT_SECRET
  MICROSOFT_CLIENT_ID:
    environment: MICROSOFT_CLIENT_ID
  MICROSOFT_CLIENT_SECRET:
    environment: MICROSOFT_CLIENT_SECRET
  SENTRY_AUTH_TOKEN:
    environment: SENTRY_AUTH_TOKEN
  MAIL_FROM_ADDRESS:
    environment: MAIL_FROM_ADDRESS
  MAIL_FROM_NAME:
    environment: MAIL_FROM_NAME
  SMTP_HOST:
    environment: SMTP_HOST

volumes:
  db_data:

const moduleNameMapper = {
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@tests/(.*)$': '<rootDir>/src/tests/$1',
    '^prisma/(.*)$': '<rootDir>/prisma/$1',
    '^server-only$': '<rootDir>/src/tests/__mocks__/server-only.ts',
};

module.exports = {
    automock: false,
    collectCoverage: process.env.COVERAGE === 'true' || process.env.CI === 'true',
    coverageDirectory: 'coverage',
    coverageProvider: 'v8',
    maxWorkers: process.env.JEST_MAX_WORKERS || '50%',
    projects: [
        {
            displayName: { name: 'api', color: 'yellow' },
            clearMocks: true,
            collectCoverageFrom: [
                '<rootDir>/src/app/api/**/*.{ts,tsx}',
                '!<rootDir>/src/**/*.d.ts',
                '!<rootDir>/**/*.stories.tsx',
            ],
            coveragePathIgnorePatterns: [
                '/node_modules/',
                '/prisma/generated/',
            ],
            moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'node'],
            moduleNameMapper,
            modulePaths: ['<rootDir>/src/'],
            setupFilesAfterEnv: ['<rootDir>/jest.setup.backend.ts'],
            testEnvironment: 'node',
            testMatch: ['<rootDir>/src/tests/api/**/*.test.ts'],
            testPathIgnorePatterns: ['/node_modules/', '/e2e/'],
            transform: {
                '^.+\\.(t|j|mj)sx?$': ['@swc/jest'],
                '^.+\\.css$': 'jest-css-modules-transform',
            },
            transformIgnorePatterns: [
                "node_modules/(?!(nanostores|better-auth|@better-auth|uncrypto|jose|@noble)/)",
            ],
            watchPathIgnorePatterns: [
                "<rootDir>/.git/",
                "<rootDir>/.github/",
                "<rootDir>/.next/",
                "<rootDir>/.vscode/",
                "<rootDir>/build/",
                "<rootDir>/coverage/",
                "<rootDir>/dist/",
                "<rootDir>/node_modules/",
                "<rootDir>/out/",
                "<rootDir>/src/tests/components/",
                "<rootDir>/src/tests/services/",
            ],
        },
        {
            displayName: { name: 'services', color: 'magenta' },
            clearMocks: true,
            collectCoverageFrom: [
                '<rootDir>/src/services/**/*.{ts,tsx}',
                '!<rootDir>/src/**/*.d.ts',
                '!<rootDir>/**/*.stories.tsx',
            ],
            coveragePathIgnorePatterns: [
                '/node_modules/',
                '/prisma/generated/',
            ],
            moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'node'],
            moduleNameMapper,
            modulePaths: ['<rootDir>/src/'],
            setupFilesAfterEnv: ['<rootDir>/jest.setup.backend.ts'],
            testEnvironment: 'node',
            testMatch: ['<rootDir>/src/tests/services/**/*.test.ts'],
            testPathIgnorePatterns: ['/node_modules/', '/e2e/'],
            transform: {
                '^.+\\.(t|j|mj)sx?$': ['@swc/jest'],
                '^.+\\.css$': 'jest-css-modules-transform',
            },
            transformIgnorePatterns: [
                "node_modules/(?!(nanostores|better-auth|@better-auth|uncrypto|jose|@noble)/)",
            ],
            watchPathIgnorePatterns: [
                "<rootDir>/.git/",
                "<rootDir>/.github/",
                "<rootDir>/.next/",
                "<rootDir>/.vscode/",
                "<rootDir>/build/",
                "<rootDir>/coverage/",
                "<rootDir>/dist/",
                "<rootDir>/node_modules/",
                "<rootDir>/out/",
            ],
        },
        {
            displayName: { name: 'components', color: 'blue' },
            clearMocks: true,
            collectCoverageFrom: [
                '<rootDir>/src/components/**/*.{ts,tsx}',
                '!<rootDir>/src/**/*.d.ts',
                '!<rootDir>/**/*.stories.tsx',
            ],
            coveragePathIgnorePatterns: [
                '/node_modules/',
                '/prisma/generated/',
            ],
            moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'node', 'mjs'],
            moduleNameMapper,
            modulePaths: ['<rootDir>/src/'],
            setupFilesAfterEnv: ['<rootDir>/jest.setup.frontend.ts'],
            testEnvironment: 'jsdom',
            testMatch: ['<rootDir>/src/tests/components/**/*.test.tsx'],
            testPathIgnorePatterns: ['/node_modules/', '/e2e/'],
            transform: {
                '^.+\\.(t|j|mj)sx?$': ['@swc/jest'],
                '^.+\\.css$': 'jest-css-modules-transform',
            },
            transformIgnorePatterns: [
                "node_modules/(?!(nanostores|better-auth|@better-auth|uncrypto|jose|@noble)/)",
            ],
            watchPathIgnorePatterns: [
                "<rootDir>/.git/",
                "<rootDir>/.github/",
                "<rootDir>/.next/",
                "<rootDir>/.vscode/",
                "<rootDir>/build/",
                "<rootDir>/coverage/",
                "<rootDir>/dist/",
                "<rootDir>/node_modules/",
                "<rootDir>/out/",
                "<rootDir>/src/tests/api/",
                "<rootDir>/src/tests/services/",
            ],
        },
    ],
};
